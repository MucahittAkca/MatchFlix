{% extends 'base.html' %}
{% load static %}

{% block title %}Bildirimler - MatchFlix{% endblock %}

{% block extra_css %}
<link href="https://fonts.googleapis.com/css2?family=Anton&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
    /* ========================================
       NOTIFICATIONS - CINEMATIC DARK THEME
       No gradients, solid colors only
    ======================================== */
    
    body {
        background-color: #000000 !important;
    }
    
    .notifications-container {
        max-width: 800px;
        margin: 0 auto;
        padding: 3rem 1.5rem;
    }
    
    /* Page Header */
    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 2rem;
        flex-wrap: wrap;
        gap: 1rem;
    }
    
    .page-title {
        font-family: 'Anton', sans-serif;
        font-size: 2.5rem;
        color: #FFFFFF;
        text-transform: uppercase;
        letter-spacing: 0.02em;
        margin-bottom: 0.5rem;
    }
    
    .unread-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .badge-count {
        background-color: #DC2626;
        color: #FFFFFF;
        font-size: 0.75rem;
        font-weight: 700;
        padding: 0.25rem 0.5rem;
    }
    
    .badge-text {
        font-size: 0.875rem;
        color: #6B7280;
    }
    
    .header-actions {
        display: flex;
        gap: 0.5rem;
    }
    
    .btn-header {
        background-color: #1A1A1A;
        color: #D1D5DB;
        border: 1px solid #27272A;
        padding: 0.5rem 1rem;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        cursor: pointer;
        text-decoration: none;
        transition: all 0.2s ease;
    }
    
    .btn-header:hover {
        border-color: #DC2626;
        color: #FFFFFF;
    }
    
    /* Notification Item */
    .notification-item {
        background-color: #0F0F0F;
        border: 1px solid #27272A;
        border-left: 4px solid #DC2626;
        padding: 1.25rem;
        margin-bottom: 0.75rem;
        transition: all 0.2s ease;
    }
    
    .notification-item.read {
        border-left-color: #27272A;
        opacity: 0.6;
    }
    
    .notification-item:hover {
        border-color: #3B3B3B;
    }
    
    .notification-content {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
    }
    
    .notification-main {
        flex: 1;
    }
    
    .notification-header {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 0.5rem;
    }
    
    .notification-icon {
        font-size: 1rem;
    }
    
    .notification-icon.friend { color: #3B82F6; }
    .notification-icon.accepted { color: #22C55E; }
    .notification-icon.rating { color: #FBBF24; }
    .notification-icon.recommendation { color: #A855F7; }
    .notification-icon.upcoming { color: #F97316; }
    .notification-icon.digest { color: #EC4899; }
    .notification-icon.default { color: #6B7280; }
    
    .notification-title {
        font-size: 0.875rem;
        font-weight: 600;
        color: #FFFFFF;
    }
    
    .unread-dot {
        width: 0.5rem;
        height: 0.5rem;
        background-color: #DC2626;
    }
    
    .notification-message {
        font-size: 0.875rem;
        color: #D1D5DB;
        margin-bottom: 0.5rem;
        line-height: 1.5;
    }
    
    .notification-meta {
        display: flex;
        align-items: center;
        gap: 1rem;
        font-size: 0.75rem;
    }
    
    .notification-time {
        color: #4B5563;
    }
    
    .notification-link {
        color: #DC2626;
        text-decoration: none;
        font-weight: 500;
        transition: opacity 0.2s ease;
    }
    
    .notification-link:hover {
        opacity: 0.8;
    }
    
    /* Action Buttons */
    .notification-actions {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-left: 1rem;
    }
    
    .btn-action {
        background: none;
        border: none;
        color: #4B5563;
        font-size: 1rem;
        cursor: pointer;
        padding: 0.25rem;
        transition: color 0.2s ease;
    }
    
    .btn-action.mark-read:hover {
        color: #22C55E;
    }
    
    .btn-action.delete:hover {
        color: #EF4444;
    }
    
    /* Empty State */
    .empty-state {
        background-color: #0F0F0F;
        border: 1px solid #27272A;
        padding: 4rem 2rem;
        text-align: center;
    }
    
    .empty-icon {
        font-size: 4rem;
        margin-bottom: 1rem;
    }
    
    .empty-title {
        font-family: 'Anton', sans-serif;
        font-size: 1.25rem;
        color: #FFFFFF;
        text-transform: uppercase;
        margin-bottom: 0.5rem;
    }
    
    .empty-text {
        font-size: 0.875rem;
        color: #6B7280;
        max-width: 24rem;
        margin: 0 auto;
    }
    
    /* Responsive */
    @media (max-width: 640px) {
        .page-header {
            flex-direction: column;
        }
        
        .page-title {
            font-size: 2rem;
        }
        
        .header-actions {
            width: 100%;
        }
        
        .btn-header {
            flex: 1;
            text-align: center;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="notifications-container">
    <!-- Header -->
    <div class="page-header">
        <div>
            <h1 class="page-title" data-i18n="notifications">Bildirimler</h1>
            <div id="unreadBadge" class="unread-badge {% if unread_count == 0 %}hidden{% endif %}">
                <span class="badge-count">{{ unread_count }}</span>
                <span class="badge-text" data-i18n="unreadNotifications">okunmamƒ±≈ü bildirim</span>
            </div>
        </div>
        
        <div class="header-actions">
            <button onclick="markAllAsRead()" class="btn-header" data-i18n="markAllRead">
                T√ºm√ºn√º Okundu ƒ∞≈üaretle
            </button>
            <a href="{% url 'edit_profile' %}#notifications" class="btn-header" data-i18n="notificationSettings">
                ‚öôÔ∏è Ayarlar
            </a>
        </div>
    </div>
    
    <!-- Notifications List -->
    <div id="notificationsList">
        {% for notification in notifications %}
        <div class="notification-item {% if notification.is_read %}read{% endif %}" data-id="{{ notification.id }}">
            <div class="notification-content">
                <div class="notification-main">
                    <div class="notification-header">
                        <!-- Icon based on type -->
                        {% if notification.notification_type == 'friend_request' %}
                        <span class="notification-icon friend">üë•</span>
                        {% elif notification.notification_type == 'friend_accepted' %}
                        <span class="notification-icon accepted">‚úÖ</span>
                        {% elif notification.notification_type == 'new_rating' %}
                        <span class="notification-icon rating">‚≠ê</span>
                        {% elif notification.notification_type == 'recommendation' %}
                        <span class="notification-icon recommendation">üé¨</span>
                        {% elif notification.notification_type == 'upcoming_movie' %}
                        <span class="notification-icon upcoming">üìÖ</span>
                        {% elif notification.notification_type == 'weekly_digest' %}
                        <span class="notification-icon digest">üìß</span>
                        {% else %}
                        <span class="notification-icon default">üîî</span>
                        {% endif %}
                        
                        <span class="notification-title">{{ notification.title }}</span>
                        
                        {% if not notification.is_read %}
                        <span class="unread-dot"></span>
                        {% endif %}
                    </div>
                    
                    <p class="notification-message">{{ notification.message }}</p>
                    
                    <div class="notification-meta">
                        <span class="notification-time">{{ notification.created_at|timesince }} √∂nce</span>
                        {% if notification.action_url %}
                        <a href="{{ notification.action_url }}" class="notification-link" onclick="markAsRead({{ notification.id }})">
                            G√∂r√ºnt√ºle ‚Üí
                        </a>
                        {% endif %}
                    </div>
                </div>
                
                <div class="notification-actions">
                    {% if not notification.is_read %}
                    <button onclick="markAsRead({{ notification.id }})" class="btn-action mark-read" title="Okundu i≈üaretle">‚úì</button>
                    {% endif %}
                    <button onclick="deleteNotification({{ notification.id }})" class="btn-action delete" title="Sil">‚úï</button>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="empty-state">
            <div class="empty-icon">üîî</div>
            <h3 class="empty-title" data-i18n="noNotifications">Hen√ºz bildirim yok</h3>
            <p class="empty-text" data-i18n="noNotificationsDesc">
                Arkada≈ülarƒ±nla etkile≈üime ge√ß ve yeni bildirimlerin burada g√∂r√ºns√ºn.
            </p>
        </div>
        {% endfor %}
    </div>
</div>

<script>
// Mark single notification as read
async function markAsRead(notificationId) {
    try {
        var response = await fetch('/notifications/api/read/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ notification_id: notificationId })
        });
        
        var data = await response.json();
        if (data.success) {
            var item = document.querySelector('[data-id="' + notificationId + '"]');
            if (item) {
                item.classList.add('read');
                // Remove unread dot
                var dot = item.querySelector('.unread-dot');
                if (dot) dot.remove();
                // Remove mark as read button
                var readBtn = item.querySelector('.btn-action.mark-read');
                if (readBtn) readBtn.remove();
            }
            updateUnreadCount();
        }
    } catch (error) {
        console.error('Error marking as read:', error);
    }
}

// Mark all notifications as read
async function markAllAsRead() {
    try {
        var response = await fetch('/notifications/api/read/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ all: true })
        });
        
        var data = await response.json();
        if (data.success) {
            // Update UI
            document.querySelectorAll('.notification-item').forEach(function(item) {
                item.classList.add('read');
            });
            // Remove all unread dots
            document.querySelectorAll('.unread-dot').forEach(function(dot) {
                dot.remove();
            });
            // Remove all mark as read buttons
            document.querySelectorAll('.btn-action.mark-read').forEach(function(btn) {
                btn.remove();
            });
            
            updateUnreadCount();
            showToast('T√ºm bildirimler okundu olarak i≈üaretlendi', 'success');
        }
    } catch (error) {
        console.error('Error marking all as read:', error);
        showToast('Bir hata olu≈ütu', 'error');
    }
}

// Delete notification
async function deleteNotification(notificationId) {
    try {
        var response = await fetch('/notifications/api/delete/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ notification_id: notificationId })
        });
        
        var data = await response.json();
        if (data.success && data.deleted) {
            var item = document.querySelector('[data-id="' + notificationId + '"]');
            if (item) {
                item.style.transition = 'all 0.3s ease';
                item.style.opacity = '0';
                item.style.transform = 'translateX(50px)';
                setTimeout(function() { item.remove(); }, 300);
            }
            updateUnreadCount();
        }
    } catch (error) {
        console.error('Error deleting notification:', error);
        showToast('Bildirim silinemedi', 'error');
    }
}

// Update unread count badge
async function updateUnreadCount() {
    try {
        var response = await fetch('/notifications/api/unread-count/');
        var data = await response.json();
        
        var badge = document.getElementById('unreadBadge');
        if (badge) {
            if (data.unread_count > 0) {
                badge.classList.remove('hidden');
                badge.querySelector('.badge-count').textContent = data.unread_count;
            } else {
                badge.classList.add('hidden');
            }
        }
        
        // Update navbar badge too
        var navBadge = document.getElementById('navNotificationBadge');
        if (navBadge) {
            if (data.unread_count > 0) {
                navBadge.classList.remove('hidden');
                navBadge.textContent = data.unread_count;
            } else {
                navBadge.classList.add('hidden');
            }
        }
    } catch (error) {
        console.error('Error updating unread count:', error);
    }
}

// Helper function to get CSRF token
function getCookie(name) {
    var cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        var cookies = document.cookie.split(';');
        for (var i = 0; i < cookies.length; i++) {
            var cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}
